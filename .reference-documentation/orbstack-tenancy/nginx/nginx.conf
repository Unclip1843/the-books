worker_processes auto;
events { worker_connections 2048; }

http {
  server_tokens off;
  sendfile on;
  client_max_body_size 10m;

  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  upstream supervisor_upstream { server supervisor:4010; keepalive 64; }

  limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;
  limit_req_zone $binary_remote_addr zone=warm:1m rate=6r/m;

  server {
    listen 8080;

    location = /health-local {
      default_type application/json;
      return 200 '{"ok":true}';
    }

    location = /warmup {
      limit_req zone=warm burst=3 nodelay;
      proxy_pass http://supervisor_upstream/warmup;
    }

    location / {
      limit_req zone=api burst=40 nodelay;
      proxy_set_header Host            $host;
      proxy_set_header X-Real-IP       $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;

      proxy_set_header Upgrade         $http_upgrade;
      proxy_set_header Connection      $connection_upgrade;

      proxy_connect_timeout 5s;
      proxy_read_timeout 75s;
      proxy_send_timeout 75s;

      proxy_pass http://supervisor_upstream;
    }
  }
}
